<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GOAT</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script type="module">
      // Firebase SDK 라이브러리 가져오기
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
      import {
        collection,
        addDoc,
      } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
      import { getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

      // Firebase 구성 정보 설정
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: 'AIzaSyAqjb8uXk3rN-Ao6-zzC7fbeW6zuCo3vaU',
        authDomain: 'sparta-1a0bd.firebaseapp.com',
        projectId: 'sparta-1a0bd',
        storageBucket: 'sparta-1a0bd.appspot.com',
        messagingSenderId: '117739619217',
        appId: '1:117739619217:web:13a6198d44aad16def5030',
        measurementId: 'G-239WZM18HP',
      };

      // Firebase 인스턴스 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      //업로드시에 사용될 정보
      let uploadDto = {
        imageUrl: '',
        mbti: '',
        name: '',
        blog: '',
        github: '',
        content: '',
        password: '',
      };

      //이미지 파일 이름 생성
      function guid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return (
          s4() +
          s4() +
          '-' +
          s4() +
          '-' +
          s4() +
          '-' +
          s4() +
          '-' +
          s4() +
          s4() +
          s4()
        );
      }
      //이미지 미리보기
      $('#imageInput').change(function () {
        $('#preview').remove();
        $('#imagebbod').append(
          `<img id="preview" class="img-thumbnail" width="330px" />`
        );

        const file = document.querySelector('#imageInput').files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById('preview').src = e.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          document.getElementById('preview').src = '';
        }
        $('#preview').attr('display');
      });
      // 정보 업로드
      $('#send').click(async function () {
        uploadDto.mbti = $('#mbti').val();
        uploadDto.name = $('#name').val();
        uploadDto.blog = $('#blog').val();
        uploadDto.github = $('#github').val();
        uploadDto.content = $('#content').val();
        //uploadDto.password = $('#password').val();

        if (
          !uploadDto.mbti ||
          !uploadDto.name ||
          !uploadDto.blog ||
          !uploadDto.github ||
          !uploadDto.content
        ) {
          alert('모든칸을 작성해 주세요!');
          return;
        }
        const file = document.querySelector('#imageInput').files[0];
        if (!file) {
          alert('이미지를 등록해주세요');
          return;
        }

        let uuid = guid();
        const imageRef = ref(storage, `images/${uuid}`);

        const data = await uploadBytes(imageRef, file)
          .then(async (res) => {
            await getDownloadURL(res.ref).then((url) => {
              uploadDto.imageUrl = url;
            });
            await addDoc(collection(db, 'information'), uploadDto).then(
              (res) => {
                alert('저장 되었습니다.');
              }
            );
          })
          .catch((err) => {
            console.log(err);
            alert('저장에 실패했습니다!');
          });
      });
    </script>

    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 10rem auto 10rem auto;
        justify-content: center;
        width: 30rem;
        border: 1px solid grey;
        border-radius: 10px;
      }
      .dark {
        background-color: black;
        color: white;
      }
      #imagebox {
        width: 100%;
      }
    </style>
  </head>
  <body type="module">
    <header>
      <h1 class="d-flex justify-content-center mt-3">GOAT에 합류하기!</h1>
    </header>
    <div class="mt-3 p-3">
      <div class="mypostingbox" id="postingbox">
        <div class="input-group mb-2" id="imagebox">
          <div>
            <input type="file" class="form-control mb-3" id="imageInput" />
          </div>
        </div>
        <div id="imagebbod"></div>
        <div class="form-floating mb-3">
          <input
            id="name"
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="이름"
          />
          <label for="floatingInput">이름</label>
        </div>
        <div class="form-floating mb-3">
          <input
            id="mbti"
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="ISTP"
          />
          <label for="floatingInput">MBTI</label>
        </div>
        <div class="form-floating mb-3">
          <input
            id="blog"
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="example.com"
          />
          <label for="floatingInput">블로그</label>
        </div>
        <div class="form-floating mb-3">
          <input
            id="github"
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="github.com/ka"
          />
          <label for="floatingInput">깃허브</label>
        </div>
        <div class="form-floating mb-3">
          <input
            id="content"
            type="text"
            class="form-control"
            id="floatingInput"
            placeholder="강점!"
          />
          <label for="floatingInput">강점</label>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <button class="btn btn-danger mt-3" id="send">등록하기</button>
          <button class="btn btn-danger mt-3">취소하기</button>
        </div>
      </div>
    </div>
  </body>
</html>
